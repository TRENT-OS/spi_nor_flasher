/*
 * Copyright (C) 2020, HENSOLDT Cyber GmbH
 */

import <std_connector.camkes>;

import "components/FlashRpi3/FlashRpi3.camkes";

#include "RamDisk/RamDisk.camkes";
DECLARE_COMPONENT_RamDisk(RamDisk)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DECLARE(TimeServer)

#include "RPI_SPI_Flash/RPI_SPI_Flash.camkes"
DECLARE_COMPONENT_RPI_SPI_FLASH_DRV(Flash)


assembly {
    composition {
        component  FlashRpi3    flashRpi3;
        component  TimeServer   timeServer;

        DECLARE_AND_CONNECT_INSTANCE_RamDisk(
          RamDisk, inputRamDisk,
          flashRpi3.inputStorage_rpc,
          flashRpi3.inputStorage_dp)

        DECLARE_AND_CONNECT_INSTANCE_RPI_SPI_FLASH(
            Flash, flash)

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            flash.timeServer_rpc, flash.timeServer_notify
        )

        connection  seL4RPCCall     conn_storage_flash_rpc(from flashRpi3.outputStorage_rpc, to flash.storage_rpc);
        connection  seL4SharedData  my_dp(from flash.storage_port, to flashRpi3.outputStorage_dp);
    }

    configuration {
        // gpio base register and size, includes the spi base register
        CONFIGURE_INSTANCE_RPI_SPI_FLASH(flash)

        TimeServer_CLIENT_ASSIGN_BADGES(
            flash.timeServer_rpc
        )

        // CONFIGURE_INSTANCE_StorageServer(
        //     storageServer,
        //     0, 64*1024)
    }
}
